<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pengaturan Tampilan Foto</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }

        .header {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .form-section {
            padding: 20px;
            background: #f8f9fa;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: #007bff;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
            outline: none;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            background: #007bff;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-wrapper:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: block;
            padding: 12px;
            text-align: center;
            font-weight: 600;
        }

        .location-input {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .location-item {
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 5px;
            font-size: 14px;
            color: #495057;
            border: 1px solid #dee2e6;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(40,167,69,0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(108,117,125,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,123,255,0.3);
        }

        .photo-preview {
            margin-top: 20px;
            text-align: center;
        }

        .photo-preview img {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .canvas-container {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #28a745;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .footer {
            background: #343a40;
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 12px;
        }

        .datetime-display {
            background: #e9ecef;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            color: #495057;
        }

        .location-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .location-button:hover {
            background: #138496;
            transform: translateY(-1px);
        }

        @media (max-width: 480px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .form-section {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            üéØ Pengaturan Tampilan Foto
        </div>
        
        <div class="form-section">
            <div class="form-group">
                <label class="form-label">üìã Mode Tampilan:</label>
                <select class="form-control" id="displayMode">
                    <option value="single">Foto Tunggal</option>
                    <option value="multiple">Foto Multiple</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">üì∑ Pilih Foto (Max 12):</label>
                <div class="file-input-wrapper">
                    <input type="file" id="photoInput" accept="image/*" multiple>
                    <label for="photoInput" class="file-input-label">Pilih File</label>
                </div>
                <div id="fileInfo" style="margin-top: 10px; font-size: 12px; color: #6c757d;"></div>
            </div>

            <div class="form-group">
                <label class="form-label">üìÖ Tanggal & Waktu Awal:</label>
                <input type="datetime-local" class="form-control" id="datetimeInput">
            </div>

            <div class="form-group">
                <label class="form-label">‚è±Ô∏è Interval (menit):</label>
                <input type="number" class="form-control" id="intervalInput" value="1" min="1">
            </div>

            <div class="form-group">
                <label class="form-label">üî§ Ukuran Font:</label>
                <input type="number" class="form-control" id="fontSizeInput" value="40" min="10" max="100">
            </div>

            <div class="form-group">
                <label class="form-label">üé® Pilih Font:</label>
                <select class="form-control" id="fontFamily">
                    <option value="Arial">Arial</option>
                    <option value="Open Sans">Open Sans</option>
                    <option value="Roboto">Roboto</option>
                    <option value="Helvetica">Helvetica</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">üìç Lokasi (dapat diedit):</label>
                <input type="text" class="form-control" id="streetInput" placeholder="Jalan/Alamat" value="Jalan Sono Indah V">
                <input type="text" class="form-control" id="districtInput" placeholder="Kecamatan/Desa" value="Sono Kwijenan" style="margin-top: 8px;">
                <input type="text" class="form-control" id="cityInput" placeholder="Kota" value="Surabaya" style="margin-top: 8px;">
                <input type="text" class="form-control" id="provinceInput" placeholder="Provinsi" value="Jawa Timur" style="margin-top: 8px;">
                <button class="location-button" onclick="getLocation()">üåç Ambil Lokasi Otomatis</button>
                <button class="location-button" onclick="resetLocation()" style="background: #dc3545; margin-left: 8px;">üîÑ Reset</button>
            </div>

            <div class="form-group">
                <button class="btn btn-secondary" onclick="goBack()">‚¨ÖÔ∏è Sebelumnya</button>
                <button class="btn btn-primary" onclick="processPhotos()">‚ú® Selanjutnya ‚û°Ô∏è</button>
            </div>

            <div id="photoPreview" class="photo-preview" style="display: none;">
                <h3 style="color: #007bff; margin-bottom: 15px;">Preview Foto:</h3>
                <div id="previewContainer"></div>
            </div>

            <div class="form-group" id="downloadSection" style="display: none;">
                <button class="btn btn-success" onclick="downloadPhoto()">‚¨áÔ∏è Download</button>
            </div>
        </div>

        <div class="footer">
            <span class="status-indicator"></span>
            ¬© 2025 Timestamp Viewer by Marsudi‚Ñ¢ - All rights reserved.
        </div>
    </div>

    <script>
        let processedPhotos = [];
        let currentLocation = {
            street: "Jalan manukan tama",
            district: "Tandes", 
            city: "Surabaya",
            province: "Jawa Timur"
        };

        // Initialize datetime input with current time
        function initializeDateTime() {
            const now = new Date();
            const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('datetimeInput').value = localISOTime;
        }

        // Update current date time display (not used anymore but kept for compatibility)
        function updateDateTime() {
            // This function is now unused but kept for compatibility
        }

        // Get current location from input fields
        function getCurrentLocation() {
            return {
                street: document.getElementById('streetInput').value,
                district: document.getElementById('districtInput').value,
                city: document.getElementById('cityInput').value,
                province: document.getElementById('provinceInput').value
            };
        }

        // Reset location to default
        function resetLocation() {
            document.getElementById('streetInput').value = "Jalan Sono Indah V";
            document.getElementById('districtInput').value = "Sono Kwijenan";
            document.getElementById('cityInput').value = "Surabaya";
            document.getElementById('provinceInput').value = "Jawa Timur";
        }

        // Get user location
        function getLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        // In real app, you would reverse geocode the coordinates
                        // For demo purposes, we'll simulate updating the location
                        document.getElementById('streetInput').value = "Jalan Otomatis Via GPS";
                        document.getElementById('districtInput').value = "Kecamatan GPS";
                        document.getElementById('cityInput').value = "Kota GPS";
                        document.getElementById('provinceInput').value = "Provinsi GPS";
                        alert('Lokasi berhasil diperbarui via GPS!');
                    },
                    (error) => {
                        alert('Tidak dapat mengakses lokasi. Silakan edit manual.');
                    }
                );
            } else {
                alert('Geolocation tidak didukung browser ini. Silakan edit manual.');
            }
        }

        // Handle file input
        document.getElementById('photoInput').addEventListener('change', function(e) {
            const files = e.target.files;
            let fileInfo = '';
            
            if (files.length > 0) {
                if (files.length === 1) {
                    fileInfo = `${files[0].name}`;
                } else {
                    fileInfo = `${files.length} foto dipilih`;
                }
                
                if (files.length > 12) {
                    alert('Maksimal 12 foto yang bisa diproses sekaligus');
                    return;
                }
            }
            
            document.getElementById('fileInfo').textContent = fileInfo;
        });

        // Process photos with timestamp
        function processPhotos() {
            const files = document.getElementById('photoInput').files;
            if (files.length === 0) {
                alert('Silakan pilih foto terlebih dahulu');
                return;
            }

            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '';
            processedPhotos = [];

            const fontSize = document.getElementById('fontSizeInput').value;
            const fontFamily = document.getElementById('fontFamily').value;
            const interval = parseInt(document.getElementById('intervalInput').value);
            
            // Get datetime from input
            const datetimeInput = document.getElementById('datetimeInput').value;
            let baseTime = new Date(datetimeInput);
            
            // Get location from input fields
            const location = getCurrentLocation();

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        
                        // Draw original image
                        ctx.drawImage(img, 0, 0);
                        
                        // Calculate timestamp for this photo
                        const photoTime = new Date(baseTime.getTime() + (index * interval * 60000));
                        const timeString = photoTime.toLocaleString('id-ID', {
                            day: '2-digit',
                            month: '2-digit', 
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: false
                        }).replace(',', '');
                        
                        // Add timestamp watermark at bottom right
                        ctx.font = `${fontSize}px ${fontFamily}`;
                        
                        // Calculate text dimensions for positioning
                        const line1 = timeString;
                        const line2 = location.street;
                        const line3 = location.district;
                        const line4 = `${location.city}`;
                        const line5 = `${location.province}`;
                        
                        // Get text width for the longest line to calculate positioning
                        const textWidths = [
                            ctx.measureText(line1).width,
                            ctx.measureText(line2).width,
                            ctx.measureText(line3).width,
                            ctx.measureText(line4).width,
                            ctx.measureText(line5).width
                        ];
                        const maxWidth = Math.max(...textWidths);
                        const padding = 20;
                        const lineHeight = parseInt(fontSize) + 5;
                        
                        // Position at bottom right
                        const textX = img.width - padding;
                        let textY = img.height - (lineHeight * 4) - padding;
                        
                        // Draw text with shadow for better visibility
                        ctx.textAlign = 'right';
                        
                        // Draw shadow (outline effect)
                        ctx.strokeStyle = 'rgba(0, 0, 0, 0.8)';
                        ctx.lineWidth = 3;
                        ctx.strokeText(line1, textX, textY);
                        ctx.strokeText(line2, textX, textY + lineHeight);
                        ctx.strokeText(line3, textX, textY + lineHeight * 2);
                        ctx.strokeText(line4, textX, textY + lineHeight * 3);
                        ctx.strokeText(line5, textX, textY + lineHeight * 4);
                        
                        // Draw white text on top
                        ctx.fillStyle = 'white';
                        ctx.fillText(line1, textX, textY);
                        ctx.fillText(line2, textX, textY + lineHeight);
                        ctx.fillText(line3, textX, textY + lineHeight * 2);
                        ctx.fillText(line4, textX, textY + lineHeight * 3);
                        ctx.fillText(line5, textX, textY + lineHeight * 4);
                        
                        // Reset text align
                        ctx.textAlign = 'left';
                        
                        // Create preview
                        const previewImg = document.createElement('img');
                        previewImg.src = canvas.toDataURL();
                        previewImg.style.maxWidth = '100%';
                        previewImg.style.margin = '10px 0';
                        previewImg.style.borderRadius = '8px';
                        previewContainer.appendChild(previewImg);
                        
                        processedPhotos.push({
                            canvas: canvas,
                            filename: `timestamped_${index + 1}_${file.name}`
                        });
                        
                        if (processedPhotos.length === files.length) {
                            document.getElementById('photoPreview').style.display = 'block';
                            document.getElementById('downloadSection').style.display = 'block';
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Download processed photos
        function downloadPhoto() {
            if (processedPhotos.length === 0) {
                alert('Tidak ada foto yang diproses');
                return;
            }

            processedPhotos.forEach((photo, index) => {
                // Create download link
                const link = document.createElement('a');
                link.download = photo.filename;
                
                // Convert canvas to blob for better compatibility
                photo.canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    link.href = url;
                    
                    // Add to DOM, click, then remove
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Clean up the URL object
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                }, 'image/jpeg', 0.9);
            });
            
            setTimeout(() => {
                alert(`${processedPhotos.length} foto berhasil didownload!`);
            }, 500);
        }

        function goBack() {
            if (confirm('Apakah Anda yakin ingin kembali? Semua perubahan akan hilang.')) {
                document.getElementById('photoPreview').style.display = 'none';
                document.getElementById('downloadSection').style.display = 'none';
                document.getElementById('photoInput').value = '';
                document.getElementById('fileInfo').textContent = '';
                processedPhotos = [];
            }
        }

        // Initialize
        initializeDateTime();
        updateDateTime();
        setInterval(updateDateTime, 1000);
    </script>
</body>
</html>